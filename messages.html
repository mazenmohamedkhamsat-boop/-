<!doctype html>
<html lang="ar" dir="rtl">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>الرسائل — خاصة</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
<div class="container py-5">
  <h3>الرسائل (خاصة)</h3>
  <p class="text-muted">ادخل الرمز لعرض الرسائل والرد عليها.</p>
  <div class="mb-3"><input id="codeIn" class="form-control" placeholder="أدخل الرمز"></div>
  <div><button id="goBtn" class="btn btn-primary">دخول</button></div>
  <div id="area" class="mt-4"></div>
</div>

<script>
const CODE = "472653";
document.getElementById('goBtn').addEventListener('click', async function(){
  const c = document.getElementById('codeIn').value.trim();
  if(c !== CODE) return alert('رمز غير صحيح');
  showMessages();
});

async function showMessages(){
  const res = await fetch('/api/messages'); const msgs = await res.json();
  const area = document.getElementById('area');
  if(!msgs.length){ area.innerHTML = '<div class="alert alert-info">لا توجد رسائل.</div>'; return; }
  let html = '<div class="list-group">';
  msgs.slice().reverse().forEach(function(m){
    html += '<div class="list-group-item"><div><strong>'+m.name+'</strong> — '+m.email+' <br><small>'+m.time+'</small></div><div class="mt-2">'+m.message+'</div><div class="mt-2"><button class="btn btn-sm btn-outline-primary" onclick="openChat(\'message\','+m.id+')">محادثة</button> <button class="btn btn-sm btn-danger" onclick="delMsg('+m.id+')">حذف</button></div></div>';
  });
  html += '</div>';
  area.innerHTML = html;
}

async function delMsg(id){ if(!confirm('حذف؟')) return; await fetch('/api/message/'+id, { method:'DELETE' }); showMessages(); }

function openChat(type, id){
  var modal = document.createElement('div'); modal.className='modal fade'; modal.id='tmpModal';
  modal.innerHTML = '<div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content">' +
    '<div class="modal-header"><h5 class="modal-title">محادثة — ' + type + ' #' + id + '</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
    '<div class="modal-body"><div id="chatArea" style="max-height:400px;overflow:auto;padding:8px;border:1px solid #eee;background:#fff;margin-bottom:8px"></div>' +
    '<div class="input-group"><input id="replyText" class="form-control" placeholder="اكتب ردك..."><button id="sendReplyBtn" class="btn btn-primary">إرسال</button></div></div></div></div>';
  document.body.appendChild(modal);
  var bs = new bootstrap.Modal(modal); bs.show();
  (async ()=>{
    const res = await fetch('/api/messages'); const msgs = await res.json();
    var m = msgs.find(function(x){ return x.id === id; });
    var area = document.getElementById('chatArea');
    area.innerHTML = '<div class="mb-2"><small class="text-muted">العميل · ' + m.time + '</small><div style="background:#f3f4f6;padding:8px;border-radius:8px">' + m.message + '</div></div>';
    (m.replies||[]).forEach(function(r){ area.innerHTML += '<div class="text-end mb-2"><small class="text-muted">أنت · ' + r.time + '</small><div style="background:#e6f0ff;padding:8px;border-radius:8px">' + r.text + '</div></div>'; });
    document.getElementById('sendReplyBtn').onclick = async function(){
      var text = document.getElementById('replyText').value.trim(); if(!text) return;
      await fetch('/api/reply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type:'message', id: id, sender:'admin', text }) });
      area.innerHTML += '<div class="text-end mb-2"><small class="text-muted">أنت · ' + new Date().toLocaleString() + '</small><div style="background:#e6f0ff;padding:8px;border-radius:8px">' + text + '</div></div>';
      document.getElementById('replyText').value = '';
    };
  })();
  modal.addEventListener('hidden.bs.modal', function(){ modal.remove(); });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>