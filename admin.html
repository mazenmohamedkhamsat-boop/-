<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة الإدارة — خاصة</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h3>لوحة الإدارة</h3>
  <p class="text-muted">ادخل الرمز للوصول (خاص بك).</p>
  <div class="mb-3"><input id="codeInput" class="form-control" placeholder="أدخل الرمز"></div>
  <div class="mb-3"><button id="loginBtn" class="btn btn-primary">دخول</button></div>
  <div id="alertArea"></div>
  <div id="adminArea" style="display:none">
    <div class="mb-3">
      <button id="refreshBtn" class="btn btn-sm btn-outline-primary">تحديث</button>
      <button id="downloadBtn" class="btn btn-sm btn-success">تنزيل CSV</button>
      <a id="messagesPageLink" class="btn btn-sm btn-secondary" href="messages.html">صفحة الرسائل</a>
    </div>
    <div class="row">
      <div class="col-md-6">
        <h5>الطلبات</h5>
        <div id="ordersBox"></div>
      </div>
      <div class="col-md-6">
        <h5>الرسائل</h5>
        <div id="messagesBox"></div>
      </div>
    </div>
  </div>
</div>

<div id="chatModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" id="chatModalContent"></div>
  </div>
</div>

<script>
const ADMIN_CODE = "472653";

function $(id){return document.getElementById(id);}

document.getElementById('loginBtn').addEventListener('click', function(){
  const code = $('codeInput').value.trim();
  if(code === ADMIN_CODE){
    $('alertArea').innerHTML = '<div class="alert alert-success">تم تسجيل الدخول</div>';
    $('adminArea').style.display = 'block';
    loadAll();
  } else {
    $('alertArea').innerHTML = '<div class="alert alert-danger">رمز غير صحيح</div>';
  }
});

document.getElementById('refreshBtn').addEventListener('click', loadAll);
document.getElementById('downloadBtn').addEventListener('click', downloadCSV);

async function loadAll(){
  await renderOrders();
  await renderMessages();
}

async function renderOrders(){
  const res = await fetch('/api/orders'); const orders = await res.json();
  const box = document.getElementById('ordersBox');
  if(!orders.length){ box.innerHTML = '<div class="alert alert-info">لا توجد طلبات.</div>'; return; }
  let html = '<div class="list-group">';
  orders.slice().reverse().forEach(function(o){
    html += '<div class="list-group-item" data-id="'+o.id+'"><div><strong>'+o.title+'</strong> — '+o.name+' <br><small>'+o.time+'</small></div><div class="mt-2">'+o.details+'</div><div class="mt-2"><button class="btn btn-sm btn-outline-primary" onclick="openChat(\'order\','+o.id+')">محادثة</button> <button class="btn btn-sm btn-danger" onclick="delOrder('+o.id+')">حذف</button></div></div>';
  });
  html += '</div>';
  box.innerHTML = html;
}

async function renderMessages(){
  const res = await fetch('/api/messages'); const msgs = await res.json();
  const box = document.getElementById('messagesBox');
  if(!msgs.length){ box.innerHTML = '<div class="alert alert-info">لا توجد رسائل.</div>'; return; }
  let html = '<div class="list-group">';
  msgs.slice().reverse().forEach(function(m){
    html += '<div class="list-group-item" data-id="'+m.id+'"><div><strong>'+m.name+'</strong> — '+m.email+' <br><small>'+m.time+'</small></div><div class="mt-2">'+m.message+'</div><div class="mt-2"><button class="btn btn-sm btn-outline-primary" onclick="openChat(\'message\','+m.id+')">محادثة</button> <button class="btn btn-sm btn-danger" onclick="delMessage('+m.id+')">حذف</button></div></div>';
  });
  html += '</div>';
  box.innerHTML = html;
}

async function delOrder(id){
  if(!confirm('حذف الطلب؟')) return;
  await fetch('/api/order/'+id, { method:'DELETE' });
  loadAll();
}

async function delMessage(id){
  if(!confirm('حذف الرسالة؟')) return;
  await fetch('/api/message/'+id, { method:'DELETE' });
  loadAll();
}

function openChat(type, id){
  var modalContent = document.getElementById('chatModalContent');
  modalContent.innerHTML = '<div class="modal-header"><h5 class="modal-title">محادثة — ' + type + ' #' + id + '</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>' +
    '<div class="modal-body"><div id="chatArea" style="max-height:400px;overflow:auto;padding:8px;border:1px solid #eee;background:#fff;margin-bottom:8px"></div>' +
    '<div class="input-group"><input id="replyText" class="form-control" placeholder="اكتب ردك..."><button id="sendReplyBtn" class="btn btn-primary">إرسال</button></div></div>';
  var modalEl = document.getElementById('chatModal');
  var modal = new bootstrap.Modal(modalEl);
  modal.show();
  loadConversation(type, id);
  document.getElementById('sendReplyBtn').onclick = function(){ sendReply(type, id); };
}

async function loadConversation(type, id){
  var area = document.getElementById('chatArea');
  area.innerHTML = '';
  if(type === 'order'){
    const res = await fetch('/api/orders'); const orders = await res.json();
    var o = orders.find(function(x){ return x.id === id; });
    if(o){
      appendMsg('user', o.details, o.time);
      (o.replies||[]).forEach(function(r){ appendMsg(r.sender, r.text, r.time); });
    }
  } else {
    const res = await fetch('/api/messages'); const msgs = await res.json();
    var m = msgs.find(function(x){ return x.id === id; });
    if(m){
      appendMsg('user', m.message, m.time);
      (m.replies||[]).forEach(function(r){ appendMsg(r.sender, r.text, r.time); });
    }
  }
  area.scrollTop = area.scrollHeight;
}

function appendMsg(sender, text, time){
  var area = document.getElementById('chatArea');
  var side = sender === 'admin' ? 'text-end' : 'text-start';
  var bubbleStyle = sender === 'admin' ? 'background:#e6f0ff;display:inline-block;padding:8px;border-radius:10px' : 'background:#f3f4f6;display:inline-block;padding:8px;border-radius:10px';
  var el = document.createElement('div');
  el.className = side + ' mb-2';
  el.innerHTML = '<small class="text-muted">' + (sender==='admin'?'أنت':'العميل') + ' · ' + time + '</small><div style="' + bubbleStyle + '">' + text + '</div>';
  area.appendChild(el);
}

async function sendReply(type, id){
  var text = document.getElementById('replyText').value.trim();
  if(!text) return;
  var time = new Date().toLocaleString();
  await fetch('/api/reply', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type, id, sender:'admin', text }) });
  appendMsg('admin', text, time);
  document.getElementById('replyText').value = '';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>